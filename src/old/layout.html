<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ficha de Medicação</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        .page-wrapper {
            height: calc(100% - 50px);
            padding: 20px;
            display: flex;
            align-items: stretch;
            background-color: #f4f4f4;
        }

        .copyright {
            clear: both;
            height: 30px;
            line-height: 30px;
            margin-left: 20px;
            margin-right: 20px;
            text-align: center;
            background-color: #fafafa;
            color: #707070;
        }
        
        .left-area {
            min-width: 220px;
            flex: 0 0 auto;
            background-color: #fafafa;
            margin-right: 10px;
            display: flex;
            flex-direction: column;
        }

        .left-area .logo-menu {
            display: block;
            flex: 0 0 auto;
            padding: 20px;
            max-width: 150px;
            max-height: 150px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .left-area .title {
            display: inline-block;
            flex: 0 0 auto;
            text-align: center;
            margin-top: 10px;
        }
        
        .left-area .patients {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .left-area .patients .nav-internados {
            
        }

        .left-area .patients .nav-internados .nav-link {
            color: #303030;
            text-align: left;
        }

        .left-area .patients .nav-internados .nav-link:hover {
            background-color: #f0f0f0;
        }

        .left-area .patients .nav-internados .nav-link.active,
        .left-area .patients .nav-internados .nav-pills .show>.nav-link {
            color: #009FD5;
            font-weight: bold;
            background-color: #e8e8e8;
            border-left: solid 3px #009FD5;
        }
        
        .right-area {
            flex: 2 1 auto;
            background-color: #fafafa;
            padding: 20px;
            overflow-y: auto;
        }


        .right-area .ficha-hospitalizacao .row .form-floating>label {
            left: auto;
        }
        
        .right-area .ficha-hospitalizacao fieldset {
            margin-top: 20px;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #fdfdfd;
            border: 1px solid #f4f4f4;
        }
        
        #medicacao-fieldset .medicacao-linha {
            padding-bottom: 5px;
            padding-top: 5px;
            margin-bottom: 10px;
            border-bottom: 1px solid #f4f4f4;
        }

        #medicacao-to-copy {
            display: none;
        }
        
        .horas-checkboxes .form-check-input,
        .horas-checkboxes .form-check-label {
            display: block;
            text-align: center;
            float: none;
            margin-left: auto;
            margin-right: auto;
        }
        
        #add-medicacao,
        #add-patient {
            text-align: center;
            vertical-align: middle;
            line-height: 50px;
            height: 50px;
            border: dashed 2px #d0d0d0;
            cursor: pointer;
            color: #a0a0a0;
            clear: both;
        }

        #add-patient {
            margin-top: 15px;
            margin-bottom: 20px;
        }
        
        #add-medicacao:hover,
        #add-patient:hover {
            border: dashed 2px #009FD5;
            color: #009FD5;
        }
        
        /*
        #add-medicacao:active,
        #add-patient:active {
            border: dashed 2px #008AB8;
            color: #008AB8;
        }
        */

        #add-medicacao:active,
        #add-patient:active {
            border: dashed 2px #FFFFFF;
            color: #FFFFFF;
            background-color: #009FD5;
        }
        
        
        #add-medicacao span,
        #add-patient span {
            display: inline-block;
            height: 50px;
        }
        
        @media print {
            .no-print {
                display: none;
            }
        }
        
        .required label::after {
            content: '*';
            color: red;
        }
        
        #form-btn-bar {
            margin-bottom: 20px;
            background-color: #fdfdfd;
        }
        
    </style>
</head>
<body>

<div class="page-wrapper container-fluid">
    
    <div class="left-area">
        
        <img class="logo-menu logo" src="../media/logo_azul.png" alt="logo" />
        
        <h3 class="title">Internados</h3>
        
        <div class="patients">
            <nav id="nav-internados" class="nav-internados nav nav-fill flex-column"></nav>
        </div>

        <div id="add-patient" data-bs-toggle="modal" data-bs-target="#adicionar-paciente-modal">
            <span><i class="fas fa-plus-circle"></i> Adicionar paciente</span>
        </div>
        
    </div>
    
    <div class="right-area">
        
        <form id="ficha-hospitalizacao" class="ficha-hospitalizacao" data-dirty="false" style="display: none;">
            <input id="patient-id" type="hidden">
            <H3>Ficha de Hospitalização <span id="apagar-paciente" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#apagar-paciente-modal"><i class="far fa-trash-alt"></i></span></H3>
            
            <fieldset class="dados-gerais-fieldset">
                <legend>Dados Gerais</legend>
                
                <div class="row">

                    <div class="col">
                        <div class="form-floating mb-3 required">
                            <input data-for-save="true" class="data-for-save form-control" id="data_atual" type="date" placeholder="Data Atual" data-sb-validations="required" required/>
                            <label for="data_atual">Data Atual</label>
                            <div class="invalid-feedback" data-sb-feedback="data_atual:required">Data Atual is required.</div>
                        </div>
                    </div>
                    
                    <div class="col">
                        <div class="form-floating mb-3 required">
                            <select data-for-save="true" class="data-for-save form-select" id="localDeInternamento" aria-label="Local de Internamento">
                                <option value=""></option>
                                <option value="Geral">Geral</option>
                                <option value="Infectocontagiosos">Infectocontagiosos</option>
                                <option value="Cirurgia">Cirurgia</option>
                                <option value="Tosquia">Tosquia</option>
                            </select>
                            <label for="localDeInternamento">Local de Internamento</label>
                        </div>
                    </div>

                </div>
                
                <div class="row">
                
                    <div class="form-floating mb-3 col required">
                        <input data-for-save="true" class="data-for-save form-control" id="nome" type="text" placeholder="Doente" data-sb-validations="required" required/>
                        <label for="nome">Doente</label>
                        <div class="invalid-feedback" data-sb-feedback="doente:required">Doente is required.</div>
                    </div>
                    <div class="form-floating mb-3 col required">
                        <input data-for-save="true" class="data-for-save form-control" id="especie" type="text" placeholder="Espécie" data-sb-validations="required" required/>
                        <label for="especie">Espécie</label>
                        <div class="invalid-feedback" data-sb-feedback="especie:required">Espécie is required.</div>
                    </div>
                    <div class="form-floating mb-3 col">
                        <input data-for-save="true" class="data-for-save form-control" id="raca" type="text" placeholder="Raça" data-sb-validations="" />
                        <label for="raca">Raça</label>
                    </div>
                    <div class="form-floating mb-3 col">
                        <input data-for-save="true" class="data-for-save form-control" id="idade" type="text" placeholder="Idade" data-sb-validations="" />
                        <label for="idade">Idade</label>
                    </div>
                    <div class="form-floating mb-3 col required">
                        <select data-for-save="true" class="data-for-save form-select" id="sexo" aria-label="sexo" data-sb-validations="required" required>
                            <option value="Macho">Macho</option>
                            <option value="Fêmea">Fêmea</option>
                            <option value="Macho Castrado">Macho Castrado</option>
                            <option value="Fêmea Esterilizada">Fêmea Esterilizada</option>
                        </select>
                        <label for="sexo">Sexo</label>
                    </div>
                
                </div>
    
                <div class="row">
                
                    <div class="form-floating mb-3 col required">
                        <input data-for-save="true" class="data-for-save form-control" id="tutor" type="text" placeholder="Tutor" data-sb-validations="required" required/>
                        <label for="tutor">Tutor</label>
                        <div class="invalid-feedback" data-sb-feedback="tutor:required">Tutor is required.</div>
                    </div>
                    <div class="form-floating mb-3 col required">
                        <input data-for-save="true" class="data-for-save form-control" id="contacto" type="text" placeholder="Contacto" data-sb-validations="required" required/>
                        <label for="contacto">Contacto</label>
                        <div class="invalid-feedback" data-sb-feedback="contacto:required">Contacto is required.</div>
                    </div>
                    <div class="form-floating mb-3 col">
                        <input data-for-save="true" class="data-for-save form-control" id="ncliente" type="text" placeholder="Nº Cliente" data-sb-validations="" />
                        <label for="ncliente">Nº Cliente</label>
                    </div>
                    <div class="form-floating mb-3 col">
                        <input data-for-save="true" class="data-for-save form-control" id="peso_entrada" type="text" placeholder="Peso Entrada" data-sb-validations="" />
                        <label for="peso_entrada">Peso Entrada</label>
                    </div>
                    <div class="form-floating mb-3 col">
                        <input data-for-save="true" class="data-for-save form-control" id="peso_dia" type="text" placeholder="Peso Dia" data-sb-validations="" />
                        <label for="peso_dia">Peso Dia</label>
                    </div>
                    
                </div>
                
            </fieldset>

            <fieldset class="referenciacao-fieldset">
                <legend>Referenciação</legend>

                <div class="row">
                    <div class="col">
                        <div class="form-check form-switch">
                            <input data-for-save="true" class="data-for-save form-check-input" type="checkbox" id="foi_referenciado">
                            <label class="form-check-label" for="foi_referenciado">O animal veio referenciado?</label>
                        </div>
                    </div>
                </div>
                
                <div id="se-referenciado" class="row" style="visibility: hidden">
                    <div class="form-floating mb-3 col">
                        <input data-for-save="true" class="data-for-save form-control" id="referencia" type="text" placeholder="Referência" data-sb-validations="" />
                        <label for="referencia">Referência</label>
                    </div>

                    <div class="form-floating mb-3 col">
                        <input data-for-save="true" class="data-for-save form-control" id="contacto_ref" type="text" placeholder="Contacto" data-sb-validations="" />
                        <label for="contacto_ref">Contacto</label>
                    </div>

                    <div class="form-floating mb-3 col">
                        <input data-for-save="true" class="data-for-save form-control" id="hora_e_rubrica" type="date" placeholder="Hora" data-sb-validations="" />
                        <label for="hora_e_rubrica">Hora</label>
                    </div>
                </div>
                
                
            </fieldset>
            
            <fieldset class="motivo-de-internamento-fieldset">
                
                <legend>Motivo de Internamento</legend>

                <div class="row">
                
                    <div class="col">
                        <div class="form-floating mb-3">
                            <input data-for-save="true" class="data-for-save form-control" id="data_entrada" type="date" placeholder="Data de Entrada" data-sb-validations="" />
                            <label for="data_entrada">Data de Entrada</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input data-for-save="true" class="data-for-save form-control" id="medico" type="text" placeholder="Médico" data-sb-validations="" />
                            <label for="medico">Médico</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input data-for-save="true" class="data-for-save form-control" id="data_cateter" type="date" placeholder="Data de Colocação de Catéter" data-sb-validations="" />
                            <label for="data_cateter">Data de Colocação de Catéter</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input data-for-save="true" class="data-for-save form-control" id="data_troca_cateter" type="date" placeholder="Data de Troca de Catéter" data-sb-validations="" />
                            <label for="data_troca_cateter">Data de Troca de Catéter</label>
                        </div>
                    </div>

                    <div class="col">
                        <div class="form-floating mb-3">
                            <textarea data-for-save="true" class="data-for-save form-control" id="diagnostico" type="text" placeholder="Diagnóstico" style="height: 10rem;" data-sb-validations=""></textarea>
                            <label for="diagnostico">Diagnóstico</label>
                        </div>
                        <div class="form-floating mb-3">
                            <textarea data-for-save="true" class="data-for-save form-control" id="sintomas" type="text" placeholder="Sintomas" style="height: 10rem;" data-sb-validations=""></textarea>
                            <label for="sintomas">Sintomas</label>
                        </div>
                    </div>
                    
                </div>
            </fieldset>

            <fieldset id="medicacao-fieldset">
                <legend>Medicação</legend>
                
                <div id="medicacao-to-copy">
                <div class="medicacao-linha row">

                    <div class="col-1 align-self-center">
                        <button type="button" class="btn btn-outline-danger" onclick="delete_row(this)"><i class="far fa-trash-alt"></i></button> 
                    </div>
                    <div class="col-2">
                        <div class="form-floating mb-2">
                            <input class="medicacao-save form-control" id="medicacao" type="text" placeholder="Medicação" />
                            <label for="medicacao">Medicação</label>
                        </div>
                    </div>

                    <div class="col-1">
                        <div class="form-floating mb-2">
                            <input class="medicacao-save form-control" id="dose" type="text" placeholder="Dose" />
                            <label for="dose">Dose</label>
                        </div>
                    </div>

                    <div class="col-1">
                        <div class="form-floating mb-2">
                            <input class="medicacao-save form-control" id="frequencia" type="text" placeholder="Freq" />
                            <label for="frequencia">Freq</label>
                        </div>
                    </div>

                    <div class="col-1">
                        <div class="form-floating mb-2">
                            <input class="medicacao-save form-control" id="via" type="text" placeholder="Via"/>
                            <label for="via">Via</label>
                        </div>
                    </div>
                    
                    <div class="col-6 mb-2 horas-checkboxes row align-items-center">
                        <div class="form-check col-1">
                            <label class="form-check-label" for="hora_8">8</label>
                            <input class="medicacao-save form-check-input" id="hora_8" type="checkbox" name="horas" data-sb-validations="" />
                        </div>
                        
                        <div class="form-check col-1">
                            <label class="form-check-label" for="hora_10">10</label>
                            <input class="medicacao-save form-check-input" id="hora_10" type="checkbox" name="horas" data-sb-validations="" />
                        </div>
                        
                        <div class="form-check col-1">
                            <label class="form-check-label" for="hora_12">12</label>
                            <input class="medicacao-save form-check-input" id="hora_12" type="checkbox" name="horas" data-sb-validations="" />
                        </div>
                        
                        <div class="form-check col-1">
                            <label class="form-check-label" for="hora_14">14</label>
                            <input class="medicacao-save form-check-input" id="hora_14" type="checkbox" name="horas" data-sb-validations="" />
                        </div>
                        
                        <div class="form-check col-1">
                            <label class="form-check-label" for="hora_16">16</label>
                            <input class="medicacao-save form-check-input" id="hora_16" type="checkbox" name="horas" data-sb-validations="" />
                        </div>
                        
                        <div class="form-check col-1">
                            <label class="form-check-label" for="hora_18">18</label>
                            <input class="medicacao-save form-check-input" id="hora_18" type="checkbox" name="horas" data-sb-validations="" />
                        </div>
                        
                        <div class="form-check col-1">
                            <label class="form-check-label" for="hora_20">20</label>
                            <input class="medicacao-save form-check-input" id="hora_20" type="checkbox" name="horas" data-sb-validations="" />
                        </div>
                        
                        <div class="form-check col-1">
                            <label class="form-check-label" for="hora_22">22</label>
                            <input class="medicacao-save form-check-input" id="hora_22" type="checkbox" name="horas" data-sb-validations="" />
                        </div>
                        
                        <div class="form-check col-1">
                            <label class="form-check-label" for="hora_24">24</label>
                            <input class="medicacao-save form-check-input" id="hora_24" type="checkbox" name="horas" data-sb-validations="" />
                        </div>
                        
                        <div class="form-check col-1">
                            <label class="form-check-label" for="hora_2">2</label>
                            <input class="medicacao-save form-check-input" id="hora_2" type="checkbox" name="horas" data-sb-validations="" />
                        </div>
                        
                        <div class="form-check col-1">
                            <label class="form-check-label" for="hora_4">4</label>
                            <input class="medicacao-save form-check-input" id="hora_4" type="checkbox" name="horas" data-sb-validations="" />
                        </div>
                        
                        <div class="form-check col-1">
                            <label class="form-check-label" for="hora_6">6</label>
                            <input class="medicacao-save form-check-input" id="hora_6" type="checkbox" name="horas" data-sb-validations="" />
                        </div>
                    </div>
                </div>
                </div>
                
                <div id="medicacao-insert"></div>
                
                <div id="add-medicacao">
                    <span><i class="fas fa-plus-circle"></i> Adicionar linha</span>
                </div>
                
            </fieldset>
            
            <fieldset class="plano-fieldset">
                <legend><label for="plano">Plano</label></legend>
                <textarea data-for-save="true" class="data-for-save form-control" id="plano" style="height: 10rem;"></textarea>
            </fieldset>

            <div id="form-btn-bar" class="btn-group float-end" role="group">
                <button class="btn btn-outline-primary btn-lg" id="guardar">Guardar</button>
                <button class="btn btn-outline-primary btn-lg" id="imprimir">Imprimir</button>
            </div>
            <div style="clear: both;"></div>
        </form>

    </div>
    
</div>

<footer class="no-print copyright">copyright (c) Ana Sofia Salazar</footer>

<!-- Modal -->
<div class="no-print modal fade" id="adicionar-paciente-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Inserir novo Paciente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-floating mb-3 required">
                    <input data-for-save="true" class="data-for-save form-control" id="criar_paciente_nome_do_paciente" type="text" placeholder="Nome"/>
                    <label for="criar_paciente_nome_do_paciente">Nome</label>
                </div>
                <div class="alert alert-danger" role="alert" id="criar_paciente_alert_error" style="visibility: hidden;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button id="criar-novo-paciente" type="button" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal apagar paciente -->
<div class="no-print modal fade" id="apagar-paciente-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Apagar paciente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Tem a certeza que deseja apagar o paciente?
            </div>
            <div class="modal-footer">
                <button id="apagar-paciente-modal-button" type="button" class="btn btn-danger" data-bs-dismiss="modal">Apagar</button>
            </div>
        </div>
    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

<script>
  
  const dbname = 'nobrevet';
  const dbversion = 1;
  var Pacientes = {};
  
  //on start
  (function(){
    
    // start db
    const request = indexedDB.open(dbname, dbversion);
    
    // create the schema Contacts object store and indexes
    request.onupgradeneeded = function (event) {
      let db = event.target.result;

      switch(event.oldVersion) {
        case 0:
          // version 0 means that the client had no database
          // perform initialization
          // create the Pacientes object store with auto-increment id
          db.createObjectStore('Pacientes', {
            autoIncrement: true
          });
          break;
        case 1:
        // client had version 1
        // update
          break;
      }
    }
    
    request.onerror = function (event) {
      console.error(`Database error: ${event.target.errorCode}`);
    }
    
    request.onsuccess = function (event) {
      let db = event.target.result;
      let txn = updatePatientList(db);

      // close the database connection
      txn.oncomplete = function () {
        db.close();
      };
      
    }

  })();

  /**
   * 
   * @param id
   * @param nome
   * @returns {HTMLAnchorElement}
   */
  function createInternadoNavItem(id, nome) {

    const item = document.createElement('a');
    item.classList.add('nav-link');
    item.classList.add('text-truncate');
    item.setAttribute('data-id', id);
    item.setAttribute('href', '#' + id);
    item.appendChild(document.createTextNode(nome));
    
    return item;
  }
  
  /**
   * 
   * @returns {null|number}
   */
  function getCurrentURLId() {
    let hash = window.location.hash;
    if (hash === '' || typeof hash === 'undefined' || hash === '#') return null; 
    
    let id = hash.substring(1);
    
    if (!/^\d+$/.test(id)) return null;
    
    return parseInt(id);
  }
  
  /**
   * 
   * @param db IDBDatabase
   * @returns {*}
   */
  function updatePatientList(db) {
    const txn = db.transaction('Pacientes', 'readonly');
    const objectStore = txn.objectStore('Pacientes');
    let pac_list = document.querySelector('#nav-internados');
    pac_list.innerHTML = '';
    Pacientes = {};

    let foundActive = false;
    objectStore.openCursor().onsuccess = function (event) {
      let cursor = event.target.result;
      
      if (cursor) {
        let paciente = cursor.value;
        Pacientes[cursor.key] = cursor.value;
        let htmlItem = createInternadoNavItem(cursor.key, paciente.nome);
        let id = getCurrentURLId();
        if (!foundActive && id === parseInt(cursor.key)) {
          htmlItem.classList.add('active');
          loadForm(id);
          foundActive = true;
        }
        
        pac_list.appendChild(htmlItem);
        
        // continue next record
        cursor.continue();
      }
    }
    
    return txn;
  }
  
  function addPatient(db, paciente) {

    // create a new transaction
    const txn = db.transaction('Pacientes', 'readwrite');

    // get the Contacts object store
    const store = txn.objectStore('Pacientes');
    //
    let query = store.put(paciente);

    // handle success case
    query.onsuccess = function (event) {
      // ermm ok blegh
    };

    // handle the error case
    query.onerror = function (event) {
      console.log(event.target.errorCode);
      alert('Erro ao criar o paciente');
    }
    
    return txn;
  }
  
  function savePatient(db, paciente, key) {

    // create a new transaction
    const txn = db.transaction('Pacientes', 'readwrite');

    // get the Contacts object store
    const store = txn.objectStore('Pacientes');
    //
    let query = store.put(paciente, key);
    
    // handle success case
    query.onsuccess = function (event) {
      // ermm ok blegh
    };

    // handle the error case
    query.onerror = function (event) {
      console.log(event.target.errorCode);
      alert('Erro ao salvar o paciente');
    }

    return txn;
  }

  function deletePatient(db, key) {
    // create a new transaction
    const txn = db.transaction('Pacientes', 'readwrite');

    // get the Contacts object store
    const store = txn.objectStore('Pacientes');
    //
    let query = store.delete(key);

    // handle success case
    query.onsuccess = function (event) {
      console.log('Paciente apagado com sucesso');
    };

    // handle the error case
    query.onerror = function (event) {
      console.log(event.target.errorCode);
      alert('Erro ao salvar o paciente');
    }

    return txn;
  }
  
  /**
   * 
   * @returns {Element|Node}
   */
  function addMedicacaoToDOM() {
    
    const med_ins = document.querySelector('#medicacao-insert');
    const medicacao_linha = document
      .querySelector('#medicacao-to-copy > .medicacao-linha')
      .cloneNode( true );

    addMedicacaoToDOM.counter = addMedicacaoToDOM.counter || (med_ins.childElementCount + 1);

    medicacao_linha.id = 'medicacao_' + addMedicacaoToDOM.counter;
    ++addMedicacaoToDOM.counter;

    medicacao_linha.classList.add("data-for-save");

    med_ins.appendChild(medicacao_linha);
    
    return medicacao_linha;
  }
  
  function delete_row(el) {
    const linha = el.parentElement.parentElement;

    if (linha.classList.contains('medicacao-linha')) {
      linha.parentNode.removeChild( linha );
    } else {
      console.log(el);
      console.log('Ocorreu um erro inesperado ao tentar remover a linha de medicação!');
    }
  }

  function loadForm(id) {
    document.getElementById('ficha-hospitalizacao').dataset.dirty = 'false';
    
    // limpar form antigo
    cleanForm();

    let paciente = Pacientes[id];
    // agora carregar a informação no formulário
    for (let key in paciente) {
      if (paciente.hasOwnProperty(key)) {

        // caso especial da medicação
        if (key === 'medicacao') {

          for (let i = 0; i < paciente.medicacao.length; ++i) {
            // primeiro criar o elemento
            let linha = addMedicacaoToDOM();

            // como somos preguiçosos, iteramos sobre o objecto em vez de aceder às propriedades directamente
            for (let subkey in paciente.medicacao[i]) {
              if (paciente.medicacao[i].hasOwnProperty(subkey)) {
                let med_param = linha.querySelector('#' + subkey);

                if (med_param.type === 'checkbox') {
                  med_param.checked = paciente.medicacao[i][subkey];
                  med_param.dispatchEvent(new Event('change'));
                } else {
                  med_param.value = paciente.medicacao[i][subkey];
                }
              }
            }
          }

        } else {
          let ele = document.getElementById(key);
          if (ele.type === 'checkbox') {
            ele.checked = paciente[key];
            ele.dispatchEvent(new Event('change'));
          } else {
            ele.value = paciente[key];
          }
        }
      }
    }

    // agora mostrar formulário
    document.querySelector('#ficha-hospitalizacao').style = '';
    document.querySelector('#patient-id').value = id;
  }
  
  function cleanForm() {
    // limpar id
    document.querySelector('#patient-id').value = null;

    // limpar medicacao
    document.querySelector('#medicacao-insert').innerHTML = '';

    //apagar forms
    let oldform = document.querySelectorAll('.data-for-save');
    
    for (let i = 0; i < oldform.length; ++i) {
      if (oldform[i].type === 'checkbox') {
        oldform[i].checked = false;
        oldform[i].dispatchEvent(new Event('change'));
      } else {
        oldform[i].value = '';
      }
    }
    document.getElementById('ficha-hospitalizacao').dataset.dirty = 'false';
  }
  
  function hideForm() {
    document.querySelector('#ficha-hospitalizacao').style = 'display: none';
  }

  /**
   * 
   * @returns {{medicacao: *[]}}
   */
  function getDataFromForm() {
    const fields = document.querySelectorAll('.data-for-save');
    let data = {
      medicacao: []
    };

    for (let i=0; i < fields.length; ++i) {

      if (fields[i].tagName === 'DIV') {
        // trata-se de uma linha de medicação, por isso vamos fazer loop pelos filhos com a classe medicacao-save
        let medline = {};
        let med_fields = fields[i].querySelectorAll('.medicacao-save');

        for (let ii=0; ii < med_fields.length; ++ii) {
          medline[med_fields[ii].id] = (med_fields[ii].type === 'checkbox') ? med_fields[ii].checked : med_fields[ii].value;
        }

        data.medicacao.push(medline);

      } else {
        data[fields[i].id] = (fields[i].type === 'checkbox') ? fields[i].checked : fields[i].value;
      }
    }
    
    return data;
  }
  
  
  document.querySelector('#ficha-hospitalizacao').addEventListener('change', function () {
    document.getElementById('ficha-hospitalizacao').dataset.dirty = 'true';
  });
  
  document.querySelector('#add-medicacao').addEventListener('click', function () {
    addMedicacaoToDOM();
  });
  
  document.querySelector('#nav-internados').addEventListener('click', function (event) {

    let item = event.target;
    
    if (item.classList.contains('nav-link')) {
      // clicou num link
      
      // para impedir perder informação, vamos ver se está dirty
      let dirty = document.getElementById('ficha-hospitalizacao').dataset.dirty;
      if (dirty === 'true') {
        let retVal = confirm("A ficha tem alterações não guardadas. Se mudar de ficha, perderá a informação. Deseja continuar?");
        if(!retVal) return;
      }
      
      // ir buscar todos os nav-links de #nav-internados e tirar a class active
      let all_links = document.querySelector('#nav-internados').querySelectorAll('.nav-link');
      for (let i = 0; i < all_links.length; ++i) {
        all_links[i].classList.remove('active');
      }
      // meter o item atual como ativo
      item.classList.add('active');
      
      // ir buscar do id
      let id = item.dataset.id;
      
      loadForm(id);
    }
    
  });
  
  function saveForm(event) {
    event.preventDefault();
    console.log('guardando...');
    let key = document.querySelector('#patient-id').value;

    if (typeof key === 'undefined' || key === '' || key === null || isNaN(key)) {
      key = window.location.hash;
    }

    if (typeof key === 'undefined' || key === '' || key === null || isNaN(key)) {
      alert('Ocorreu um erro. Por favor, faça refresh da página!');
      return;
    }

    key = parseInt(key);
    
    let data = getDataFromForm();
    console.log(data);
    const request = indexedDB.open(dbname, dbversion);
    
    request.onsuccess = function (event) {
      let db = event.target.result;
      let txn = savePatient(db, data, key);

      // close the database connection
      txn.oncomplete = function () {
        let txn2 = updatePatientList(db);

        txn2.oncomplete = function () {
          db.close();
          document.getElementById('ficha-hospitalizacao').dataset.dirty = 'false';
          alert('registo guardado com sucesso');
        };
      };
    }

    request.onerror = function (event) {
      console.error(`Database error: ${event.target.errorCode}`);
      alert('Ocorreu um erro. Por favor, faça refresh da página!');
    }
    
  }
  
  document.querySelector('#guardar').addEventListener('click', function(event) {
    event.preventDefault();
    saveForm(event);
  });
  
  document.querySelector('#imprimir').addEventListener('click', function (event) {
    event.preventDefault();
    
    let dirty = document.getElementById('ficha-hospitalizacao').dataset.dirty;
    if (dirty === 'true') {
      let retVal = confirm("A ficha tem alterações não guardadas. Deseja prosseguir com a impressão?");
      if(!retVal) return; 
    }
    
    let data = getDataFromForm();
    let json = JSON.stringify(data);
    let payload = 'json=' + encodeURIComponent(json);
    let url = 'print.html#' + payload;
    
    window.open(url,'_blank');
  });

  document.querySelector('#adicionar-paciente-modal').addEventListener('hidden.bs.modal', function (event) {
    let nome_input = document.querySelector('#criar_paciente_nome_do_paciente');
    nome_input.value = '';
    nome_input.classList.remove("is-invalid");
    let alert_div = document.querySelector('#criar_paciente_alert_error');
    alert_div.innerHTML = '';
    alert_div.style.visibility='hidden';
  });  
  
  document.querySelector('#criar-novo-paciente').addEventListener('click', function (event) {
    let dirty = document.getElementById('ficha-hospitalizacao').dataset.dirty;
    if (dirty === 'true') {
      let retVal = confirm("A ficha tem alterações não guardadas. Se mudar de ficha, perderá a informação. Deseja continuar?");
      if(!retVal) return;
    }
    
    let nome_input = document.querySelector('#criar_paciente_nome_do_paciente');
    let alert_div = document.querySelector('#criar_paciente_alert_error');
    let nome = nome_input.value;
    const this_model = document.querySelector('#adicionar-paciente-modal');
    const modal = bootstrap.Modal.getInstance(this_model);
    
    if (nome === '' || nome.trim() === '') {
      alert_div.style.visibility = 'visible';
      alert_div.innerHTML = 'O nome não pode estar vazio';
      nome_input.classList.add("is-invalid");
      return false;
    
    } else {
      alert_div.innerHTML = '';
      alert_div.style.visibility = 'hidden';
      nome_input.classList.remove("is-invalid");
      
      
      // inserir na DB
      const request = indexedDB.open(dbname, dbversion);

      request.onerror = function (event) {
        let msg = `Database error: ${event.target.errorCode}`;
        console.error(msg);
        alert_div.style.visibility = 'visible';
        alert_div.innerHTML = msg;
      }

      request.onsuccess = function (event) {
        let db = event.target.result;
        let txn = addPatient(db, {nome: nome});

        // close the database connection
        txn.oncomplete = function () {
          // update Pacientes
          let txn2 = updatePatientList(db);

          // close the database connection
          txn2.oncomplete = function () {
            db.close();
            modal.hide();
          }
        };
      }
    }
  });
    
  document.querySelector('#foi_referenciado').addEventListener('change', function (event) {
    if (event.target.checked) {
      document.querySelector('#se-referenciado').style.visibility = 'visible';
    } else {
      document.querySelector('#se-referenciado').style.visibility = 'hidden';
    }
  });

  document.querySelector('#apagar-paciente-modal-button').addEventListener('click', function (event) {
    
    let id = getCurrentURLId();
    if (id === null) {
      alert('Não foi possível apagar o paciente. Razão: o id não foi encontrado!');
      return;
    }
    
    const request = indexedDB.open(dbname, dbversion);
    request.onsuccess = function (event) {

      let db = event.target.result;
      let txn = deletePatient(db, id);

      // close the database connection
      txn.oncomplete = function () {
        cleanForm();
        hideForm();
        let txn2 = updatePatientList(db);

        txn2.oncomplete = function () {
          db.close();
          alert('Paciente apagado com sucesso');
        };
      };
    }

    request.onerror = function (event) {
      console.error(`Database error: ${event.target.errorCode}`);
      alert('Ocorreu um erro. Por favor, faça refresh da página!');
    }
    
  });
  
</script>


</body>
</html>
